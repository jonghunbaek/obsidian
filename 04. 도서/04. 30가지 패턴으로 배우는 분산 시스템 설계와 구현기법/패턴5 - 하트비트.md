# 1. 문제점
[[패턴4 - 리더 팔로워]]모델에서 가장 중요한 요소 중 하나는 리더의 실패를 감지하고, 새로운 리더를 선출하는 것이다.
또한 해당 모델이 데이터 일관성 유지의 핵심임을 생각했을 때, 서버의 실패를 적시에 감지하는 것은 매우 중요한 일이다.
그럼 리더(서버)의 실패를 감지는 방법은 무엇일까?

# 2. 해결책
바로 모든 서버에 주기적으로 하트비트라는 요청을 보내 송신 서버의 활동성을 알리는 것이다.
하트비트 요청을 보낼 때 주요 고려사항이 있다.
```text
타임아웃 간격 > 요청 시간 간격 > 서버 간 네트워크 왕복시간
```
이 기준이 중요한 이유는 **거짓 음성을 예방할 수 있기 때문**이다.

### 하트비트 송수신
하트비트를 송신/수신하는 서버 모두 스케줄러를 통해 주기적으로 요청을 보내고 처리한다. 
송신 서버에선 주기적으로 하트비트를 보내야 하고, 수신 서버에선 주기적으로 하트비트가 정상 도착했는지 확인하여 실패 감지를 한다.

### 서버 실패 판단 기준
서버의 실패 여부를 판단하는 것은 일종의 트레이드 오프다. 
하트비트의 간격이 짧다면 적시에 서버 실패를 감지할 수 있지만, 거짓 음성이될 확률이 높아진다. 
반대로 간격이 짧다면 거짓 음성이될 확률은 낮아지지만 서버 실패를 적시에 감지하지 못해 데이터 일관성이 깨질 수 있다. 

따라서 이러한 트레이드 오프는 클러스터의 규모를 기반으로 구분할 수 있다. 
# 3. 클러스터 규모별 하트비트 전략
### 소규모 클러스터 : 합의 기반 시스템
모든 합의 시스템 구현에서 하트비트는 리더 서버에서 전체 팔로워 서버로 전송된다. 
수신된 하트비트의 타임스탬프를 기록하여 수신 주기를 확인하고, 제시간에 받지 못하면 리더가 실패했다고 간주한다. 
이 과정에서 프로세스들이 느리거나 네트워크 지연으로 **가짜 실패를 감지할 가능성**이 존재한다. 

가짜 실패를 감지했다고 해도 실패로 보기에 새로운 리더가 선출이 된다.
이 때, 기존 리더는 아직 자신이 리더라고 생각하고 하트비트를 보내게 된다.
하트비트엔 일반적으로 세대 시계가 포함되기 때문에 이 요청에 대한 응답을 받고난 후에 기존 리더는 팔로워가 된다. 
